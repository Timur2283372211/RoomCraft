import"./modulepreload-polyfill-3cfb730f.js";const t=new fabric.Canvas("canvas",{selection:!0,preserveObjectStacking:!0,isDrawingMode:!1,imageSmoothingEnabled:!0,renderOnAddRemove:!0,skipOffscreen:!1});typeof window.ethereum<"u"?console.log("MetaMask is installed!"):console.log("Please install MetaMask!");const I=t.width,S=t.height,M=100,B=100;function O(){t.clear();for(let e=0;e<=S+1e5;e=e+B){const n=new fabric.Line([-1e5,e-5e4,I+1e5,e-5e4],{stroke:"#ccc",strokeWidth:2,protected:!0,selectable:!1});t.add(n),t.sendToBack(n)}for(let e=0;e<=I+1e5;e=e+M){const n=new fabric.Line([e-5e4,9e4,e-5e4,S-1e5],{stroke:"#ccc",strokeWidth:2,protected:!0,selectable:!1});t.add(n),t.sendToBack(n)}t.renderAll()}t.on("mouse:wheel",e=>{const n=e.e.deltaY,o=.01;let r=t.getZoom();const i={x:t.getWidth()/2,y:t.getHeight()/2};n>0?(r-=o,r<.1&&(r=.1)):(r+=o,r>3&&(r=3)),t.zoomToPoint(i,r),e.e.preventDefault(),e.e.stopPropagation()});O();let C=!1,v,k;t.on("mouse:down",e=>{e.e.ctrlKey&&(C=!0,v=e.e.clientX,k=e.e.clientY,t.selection=!1)});t.on("mouse:move",e=>{if(C){const n=e.e.clientX-v,o=e.e.clientY-k;t.relativePan({x:n,y:o}),v=e.e.clientX,k=e.e.clientY}});t.on("mouse:up",()=>{C=!1,t.selection=!0});document.addEventListener("keydown",e=>{e.key==="0"&&(t.setZoom(1),t.viewportTransform=[1,0,0,1,0,0])});let s=[],c=null,b=null,p=!1,l={};document.getElementById("draw-dot-btn").addEventListener("click",L);function L(){p=!p,p?(t.isDrawingMode=!1,t.selection=!1,t.defaultCursor="crosshair",l.mouseDown=e=>{var o;const n=t.getPointer(e.e);if((o=e.target)!=null&&o.isControlPoint){b=e.target.pointIndex;return}s.push({x:n.x,y:n.y}),w(),x()},l.mouseMove=e=>{if(b===null)return;const n=t.getPointer(e.e);s[b]={x:n.x,y:n.y},w(),x()},l.mouseUp=()=>{b=null},l.dblClick=e=>{if(s.length<2)return;const n=t.getPointer(e.e);let o=null,r=1/0;for(let i=0;i<s.length;i++){const d=(i+1)%s.length,a=A(n,s[i],s[d]);a<r&&(r=a,o=i)}if(o!==null&&r<20){const i=o+1;s.splice(i,0,{x:n.x,y:n.y}),w(),x()}},t.on("mouse:down",l.mouseDown),t.on("mouse:move",l.mouseMove),t.on("mouse:up",l.mouseUp),t.on("mouse:dblclick",l.dblClick)):(t.defaultCursor="default",l.mouseDown&&t.off("mouse:down",l.mouseDown),l.mouseMove&&t.off("mouse:move",l.mouseMove),l.mouseUp&&t.off("mouse:up",l.mouseUp),l.dblClick&&t.off("mouse:dblclick",l.dblClick),l={})}function w(){const e=j(s);c&&t.remove(c),s.length>1&&(c=new fabric.Path(e,{fill:"rgba(100, 200, 255, 0.5)",stroke:"blue",strokeWidth:2,selectable:!0}),t.add(c))}function x(){t.getObjects().filter(e=>e.isControlPoint).forEach(e=>t.remove(e)),s.forEach((e,n)=>{const o=new fabric.Circle({left:e.x,top:e.y,radius:5,fill:"red",originX:"center",originY:"center",isControlPoint:!0,pointIndex:n,selectable:!1,hasControls:!1,hasBorders:!1});t.add(o)})}function j(e,n=!1){if(e.length===0)return"";let o=`M ${e[0].x} ${e[0].y}`;for(let r=1;r<e.length;r++)o+=` L ${e[r].x} ${e[r].y}`;return n?o+" z":o}function A(e,n,o){const r=e.x-n.x,i=e.y-n.y,d=o.x-n.x,a=o.y-n.y,D=r*d+i*a,E=d*d+a*a;let f=-1;E!==0&&(f=D/E);let g,h;return f<0?(g=n.x,h=n.y):f>1?(g=o.x,h=o.y):(g=n.x+f*d,h=n.y+f*a),Math.sqrt((e.x-g)**2+(e.y-h)**2)}document.getElementById("draw-dot-btn").addEventListener("click",L);document.getElementById("finish").addEventListener("click",()=>{if(s.length>=3){const e=j(s,!0);R(e)}});function R(e){c&&t.remove(c),c=new fabric.Path(e,{fill:"rgba(100, 200, 255, 0.5)",stroke:"blue",strokeWidth:2,selectable:!0}),t.add(c)}document.getElementById("save-btn").addEventListener("click",()=>{try{const n=new URLSearchParams(window.location.search).get("id")||T(),o=t.toDataURL({format:"png",quality:.8}),r=JSON.parse(localStorage.getItem("projects")||"{}");r[n]=o,localStorage.setItem("projects",JSON.stringify(r)),alert("Проект успішно збережено!")}catch(e){console.error("Помилка збереження:",e),alert("Сталася помилка при збереженні")}});function T(){return"project-"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}if(window.location.search.includes("id=")){const e=new URLSearchParams(window.location.search).get("id"),n=JSON.parse(localStorage.getItem("projects")||"{}");n[e]&&fabric.Image.fromURL(n[e],function(o){t.add(o).renderAll()},{crossOrigin:"anonymous"})}document.getElementById("clear-btn").addEventListener("click",()=>{t.getObjects().forEach(e=>{e.protected||t.remove(e)}),t.renderAll()});let u=!1,m=null;document.getElementById("draw-btn").addEventListener("click",function(){u=!u,u?(this.textContent="Зупинити малювання",t.selection=!1,t.defaultCursor="crosshair"):(this.textContent="Режим малювання",t.selection=!0,t.defaultCursor="default")});t.on("mouse:down",function(e){if(!u)return;const n=t.getPointer(e.e);m=new fabric.Path(`M ${n.x} ${n.y}`,{stroke:document.getElementById("color-picker").value,strokeWidth:3,fill:"transparent",selectable:!1}),t.add(m)});t.on("mouse:move",function(e){if(!u||!m)return;const n=t.getPointer(e.e);m.path.push(["L",n.x,n.y]),t.requestRenderAll()});t.on("mouse:up",function(){m=null});let y=null,P=!1;document.getElementById("add-text-btn").addEventListener("click",()=>{P||(y=new fabric.Textbox("Натисніть для редагування",{left:100,top:100,width:200,fontSize:20,fill:"#000000",borderColor:"#3f51b5",cornerColor:"#3f51b5",cornerSize:10,transparentCorners:!1,hasControls:!0,lockUniScaling:!0,padding:5}),t.add(y),t.setActiveObject(y),t.requestRenderAll())});document.getElementById("edit-text-btn").addEventListener("click",()=>{const e=t.getActiveObject();if(!e||!(e instanceof fabric.Textbox)){alert("Виберіть текстовий об'єкт для редагування");return}P=!0,e.enterEditing(),e.hiddenTextarea.focus(),e.on("editing:exited",()=>{P=!1})});t.on("object:selected",e=>{e.target instanceof fabric.Textbox&&(e.target.set({borderColor:"#ff5722",cornerColor:"#ff5722"}),t.requestRenderAll())});t.on("object:modified",e=>{console.log("Об'єкт змінено:",e.target)});
